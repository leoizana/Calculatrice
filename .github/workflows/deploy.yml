# .github/workflows/deploy.yml
name: Deploy Project

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Create remote dir
        run: |
          sshpass -p "${{ secrets.PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.SERVER_HOSTNAME }} \
          "mkdir -p ~/node-app/dist"

      - name: Upload dist via SCP
        run: |
          sshpass -p "${{ secrets.PASSWORD }}" \
          scp -o StrictHostKeyChecking=no -r dist/* \
          ${{ secrets.USERNAME }}@${{ secrets.SERVER_HOSTNAME }}:~/node-app/dist/

      - name: Restart app (PM2) or serve static
        run: |
          sshpass -p "${{ secrets.PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.SERVER_HOSTNAME }} "
            set -e
            cd ~/node-app
            # si c'est une app Node, dÃ©commente :
            # npm ci --omit=dev || npm install --production
            if command -v pm2 >/dev/null 2>&1; then
              pm2 describe node-app >/dev/null 2>&1 \
                && pm2 reload node-app --update-env \
                || pm2 start 'npx serve -s dist -l 3000' --name node-app
              pm2 save || true
            fi
          "
